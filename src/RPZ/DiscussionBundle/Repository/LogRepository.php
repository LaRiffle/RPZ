<?php

namespace RPZ\DiscussionBundle\Repository;

/**
 * LogRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LogRepository extends \Doctrine\ORM\EntityRepository
{
  public function lastActivity() {
    $threshold_date = new \DateTime();
    $threshold_date->modify('-2 months');
    return $this->createQueryBuilder('log')
        ->select('log.username, MAX(log.date) as date')
        ->andWhere('log.date > :threshold_date')
        ->setParameter('threshold_date', $threshold_date)
        ->groupBy('log.username')
        ->orderBy('date', 'desc')
        ->getQuery()
        ->getResult()
    ;
  }
  public function lastConnexionDate($username) {
    $current_date = new \DateTime();
    $current_date->modify('-30 minutes');
    $threshold_date = new \DateTime();
    $threshold_date->modify('-2 months');
    $results =  $this->createQueryBuilder('log')
        ->select('MAX(log.date) as date')
        ->where('log.username = :username')
        ->andWhere('log.date < :current_date')
        ->andWhere('log.date > :threshold_date')
        ->setParameter('username', $username)
        ->setParameter('current_date', $current_date)
        ->setParameter('threshold_date', $threshold_date)
        ->getQuery()
        ->getResult()
    ;
    return $results[0]['date'];
  }
}
